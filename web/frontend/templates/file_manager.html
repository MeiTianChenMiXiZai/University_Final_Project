<div class="p-6 max-w-5xl mx-auto">

    <h1 class="text-3xl font-bold mt-4">çŸ¥è¯†åº“</h1>

    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <div class="flex justify-between items-center mt-4">
        <p class="text-gray-600">ç®¡ç†ä½ çš„çŸ¥è¯†åº“æ–‡ä»¶</p>
        <div>
            <button onclick="openUploadModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow">
                + æ·»åŠ æ–‡æ¡£
            </button>
            <button onclick="refreshFileList()" class="bg-gray-500 text-white px-4 py-2 rounded shadow ml-2">
                ğŸ”„ åˆ·æ–°
            </button>
        </div>
    </div>

    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <div class="mt-6 bg-white shadow-lg rounded-lg overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6">æ–‡ä»¶å</th>
                    <th class="py-3 px-6">å¤§å°</th>
                    <th class="py-3 px-6">ä¸Šä¼ æ—¶é—´</th>
                    <th class="py-3 px-6">çŠ¶æ€</th>
                    <th class="py-3 px-6">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="file-list" hx-get="/file-list/" hx-trigger="load">

            </tbody>
        </table>
    </div>

    <!-- è§£æ & ä¸Šä¼ çŠ¶æ€ -->
    <div id="status-messages" class="mt-4 text-sm text-gray-700"></div>

    <!-- è§£ææ‰€æœ‰æ–‡ä»¶ -->
    <button hx-post="/parse-all/" hx-target="#status-messages" class="bg-green-500 text-white px-4 py-2 mt-4">
        å…¨éƒ¨è§£æ
    </button>
</div>

<!-- ğŸ”¹ ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡† -->
<!-- ğŸ”¹ ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡† -->
<div id="upload-modal" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
    <div class="bg-white rounded-lg shadow-lg w-96 p-6">
        <h2 class="text-xl font-semibold mb-4">æ·»åŠ æ–‡æ¡£</h2>

        <!-- é€‰æ‹©åŒº / æ–‡ä»¶å±•ç¤º -->
        <div id="drop-area" class="border-dashed border-2 border-gray-400 p-6 text-center cursor-pointer">
            <p id="drop-hint" class="text-gray-600">ç‚¹å‡»é€‰æ‹©</p>
            <p id="selected-filename" class="text-gray-800 font-medium hidden"></p>
            <input type="file" id="file-input" class="hidden">
        </div>

        <!-- ğŸ”¹ è¿›åº¦æ¡ -->
        <div id="progress-container" class="hidden w-full bg-gray-200 rounded mt-4">
            <div id="progress-bar" class="bg-blue-600 text-xs text-white text-center p-1 leading-none rounded w-0">
                0%
            </div>
        </div>

        <button id="upload-btn" class="bg-blue-600 text-white px-4 py-2 rounded mt-4 w-full">ä¸Šä¼ æ–‡ä»¶</button>

        <div id="upload-status" class="mt-2 text-sm text-gray-700"></div>

        <button id="close-btn" class="text-red-500 mt-4 block mx-auto hidden">
            å…³é—­
        </button>
    </div>
</div>




<!-- æ–‡æ¡£æŸ¥çœ‹å¼¹çª— -->
<div id="document-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-[90%] max-w-5xl p-6 max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">æ–‡æ¡£é¢„è§ˆ</h2>
            <button onclick="closeDocumentViewer()" class="text-red-500">âœ–</button>
        </div>
        <div id="document-viewer" class="overflow-auto max-h-[70vh]">
            <p class="text-gray-500">è¯·é€‰æ‹©æ–‡ä»¶è¿›è¡Œé¢„è§ˆ</p>
        </div>
    </div>
</div>


<script>
    let selectedFile = null;

    function openUploadModal() {
        document.getElementById('upload-modal').classList.remove('hidden');
        resetUploadModal();
    }

    function closeUploadModal() {
        document.getElementById('upload-modal').classList.add('hidden');
        refreshFileList();
    }

    function refreshFileList() {
        fetch("/file-list/")
            .then(response => response.text())
            .then(html => {
                document.getElementById("file-list").innerHTML = html;
            })
            .catch(error => {
                console.error("âŒ åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥:", error);
            });
    }

    function resetUploadModal() {
        selectedFile = null;
        document.getElementById('file-input').value = null;
        document.getElementById('drop-hint').classList.remove('hidden');
        document.getElementById('selected-filename').classList.add('hidden');
        document.getElementById('selected-filename').innerText = "";
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('progress-bar').style.width = "0%";
        document.getElementById('progress-bar').innerText = "0%";
        document.getElementById('upload-status').innerHTML = "";
        document.getElementById('close-btn').classList.add('hidden');
        document.getElementById('upload-btn').classList.remove('hidden');
        document.getElementById('drop-area').classList.remove('pointer-events-none');
    }

    document.getElementById('drop-area').addEventListener('click', () => {
        document.getElementById('file-input').click();
    });

    document.getElementById('drop-area').addEventListener('drop', (event) => {
        event.preventDefault();
        if (event.dataTransfer.files.length > 0) {
            showSelectedFile(event.dataTransfer.files[0]);
        }
    });

    document.getElementById('drop-area').addEventListener('dragover', (event) => {
        event.preventDefault();
    });

    document.getElementById('file-input').addEventListener('change', function() {
        if (this.files.length > 0) {
            showSelectedFile(this.files[0]);
        }
    });

    document.getElementById('close-btn').addEventListener('click', closeUploadModal);

    function showSelectedFile(file) {
        selectedFile = file;
        document.getElementById('drop-hint').classList.add('hidden');
        document.getElementById('selected-filename').classList.remove('hidden');
        document.getElementById('selected-filename').innerText = file.name;
    }

    document.getElementById('upload-btn').addEventListener('click', () => {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("file", selectedFile);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload/", true);

        const isWord = selectedFile.name.toLowerCase().endsWith(".docx");

        xhr.upload.onprogress = function (event) {
            let percent = Math.round((event.loaded / event.total) * 100);
            if (isWord && percent === 100) {
                percent = 50;
            }
            document.getElementById("progress-container").classList.remove("hidden");
            document.getElementById("progress-bar").style.width = percent + "%";
            document.getElementById("progress-bar").innerText = percent + "%";
        };

        xhr.onload = function () {
            const response = JSON.parse(xhr.responseText);
            document.getElementById("upload-status").innerHTML = `<p class="text-blue-600">${response.message}</p>`;
            document.getElementById("progress-bar").style.width = "100%";
            document.getElementById("progress-bar").innerText = "å®Œæˆ";
            document.getElementById("upload-btn").classList.add("hidden");
            document.getElementById("close-btn").classList.remove("hidden");
            document.getElementById("drop-area").classList.add("pointer-events-none");
        };

        xhr.onerror = function () {
            document.getElementById("upload-status").innerHTML = "âŒ ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥";
        };

        xhr.send(formData);
    });
</script>